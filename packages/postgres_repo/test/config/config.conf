{
  port = 3033
  url = ${?PLATFORM_URL}
  config_dir = "../../../meshql/test/config/"
  aaa = ${config_dir}json/farm.schema.json

  # Centralized database configuration
  database {
    type = "postgres"
    host = ${?POSTGRES_HOST}
    port = ${?POSTGRES_PORT}
    db = ${?POSTGRES_DB}
    user = ${?POSTGRES_USER}
    password = ${?POSTGRES_PASSWORD}
  }

  # Use the same database configuration for each entity, just change the table name
  henDB = ${database}
  henDB.table = ${?PREFIX}_${?ENV}_hen

  coopDB = ${database}
  coopDB.table = ${?PREFIX}_${?ENV}_coop

  farmDB = ${database}
  farmDB.table = ${?PREFIX}_${?ENV}_farm

  graphlettes = [
    {
      path = "/farm/graph"
      storage = ${farmDB}
      schema = include file(${config_dir}graph/farm.graphql)
      rootConfig {
        singletons = [
          {
            # e.g. "getById" can read by checking the "id" column
            name = "getById"
            query = """
            SELECT *
            FROM {{_name}}
            WHERE id = '{{id}}'
              AND created_at <= '{{_createdAt}}'
              AND deleted = FALSE
            ORDER BY created_at DESC
            LIMIT 1
            """
          }
        ]
        vectors = []
        resolvers = [
          {
            name = "coops"
            queryName = "getByFarm"
            url = "http://localhost:3033/coop/graph"
          }
        ]
      }
    },
    {
      path = "/coop/graph"
      storage = ${coopDB}
      schema = include file(${config_dir}graph/coop.graphql)
      rootConfig {
        singletons = [
          {
            name = "getByName"
            id = "name"
            query = """
            SELECT *
            FROM {{_name}}
            WHERE payload->>'name' = '{{id}}'
              AND created_at <= '{{_createdAt}}'
              AND deleted = FALSE
            ORDER BY created_at DESC
            LIMIT 1
            """
          },
          {
            name = "getById"
            query = """
            SELECT *
            FROM {{_name}}
            WHERE id = '{{id}}'
              AND created_at <= '{{_createdAt}}'
              AND deleted = FALSE
            ORDER BY created_at DESC
            LIMIT 1
            """
          }
        ]
        vectors = [
          {
            name = "getByFarm"
            query = """
            SELECT *
            FROM {{_name}}
            WHERE payload->>'farm_id' = '{{id}}'
              AND created_at <= '{{_createdAt}}'
              AND deleted = FALSE
            ORDER BY created_at DESC
            """
          }
        ]
        resolvers = [
          {
            name = "farm"
            id = "farm_id"
            queryName = "getById"
            url = "http://localhost:3033/farm/graph"
          },
          {
            name = "hens"
            queryName = "getByCoop"
            url = "http://localhost:3033/hen/graph"
          }
        ]
      }
    },
    {
      path = "/hen/graph"
      storage = ${henDB}
      schema = include file(${config_dir}graph/hen.graphql)
      rootConfig {
        singletons = [
          {
            name = "getById"
            query = """
            SELECT *
            FROM {{_name}}
            WHERE id = '{{id}}'
              AND created_at <= '{{_createdAt}}'
              AND deleted = FALSE
            ORDER BY created_at DESC
            LIMIT 1
            """
          }
        ]
        vectors = [
          {
            name = "getByName"
            query = """
            SELECT *
            FROM {{_name}}
            WHERE payload->>'name' = '{{name}}'
              AND created_at <= '{{_createdAt}}'
              AND deleted = FALSE
            ORDER BY created_at DESC
            """
          },
          {
            name = "getByCoop"
            query = """
            SELECT *
            FROM {{_name}}
            WHERE payload->>'coop_id' = '{{id}}'
              AND created_at <= '{{_createdAt}}'
              AND deleted = FALSE
            ORDER BY created_at DESC
            """
          }
        ]
        resolvers = [
          {
            name = "coop"
            id = "coop_id"
            queryName = "getById"
            url = "http://localhost:3033/coop/graph"
          }
        ]
      }
    }
  ]

  restlettes = [
    {
      path = "/farm/api"
      storage = ${farmDB}
      schema = include file(${config_dir}json/farm.schema.json)
    },
    {
      path = "/coop/api"
      storage = ${coopDB}
      schema = include file(${config_dir}json/coop.schema.json)
    },
    {
      path = "/hen/api"
      storage = ${henDB}
      schema = include file(${config_dir}json/hen.schema.json)
    }
  ]
}